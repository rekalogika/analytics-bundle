{% block control %}
    {% set id = random() %}

    <div data-controller="rekalogika--analytics-bundle--pivot-table"
         {% if target %}data-rekalogika--analytics-bundle--pivot-table-target-value="{{ target }}"{% endif %}
         {% if output %}data-rekalogika--analytics-bundle--pivot-table-output-value="{{ output }}"{% endif %}
         {% if urlParameter %} data-rekalogika--analytics-bundle--pivot-table-url-parameter-value="{{ urlParameter }}" {% endif %}>
        {{ block("fields") }}
        <turbo-frame id="__filters">
        </turbo-frame>
    </div>

    {{ block("turbo_stream") }}
{% endblock %}

{% block turbo_stream %}
    <turbo-frame id="turbo-frame">
        <turbo-stream action="update" target="{{ target }}">
            <template>
                {{ output|raw }}
            </template>
        </turbo-stream>

        <turbo-stream action="update" target="__filters">
            <template>
                {{ block("filters") }}
            </template>
        </turbo-stream>
    </turbo-frame>
{% endblock turbo_stream %}

{% block fields %}
    <div class="row g-md-3 gx-3">
        <div class="col-md-4">
            <div class="row g-3 gx-3">
                <div class="col-12">
                    {% set type = "available" %}
                    {{ block("item_block") }}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="row g-md-3 gx-3">
                <div class="col-md-6">
                    {% set type = "rows" %}
                    {{ block("item_block") }}
                </div>

                <div class="col-md-6">
                    {% set type = "columns" %}
                    {{ block("item_block") }}
                </div>

                <div class="col-md-6">
                    {% set type = "values" %}
                    {{ block("item_block") }}
                </div>

                <div class="col-md-6">
                    {% set type = "filters" %}
                    {{ block("item_block") }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block item_block %}
    {% if type == 'available' %}
        {% set items = query.availableWithoutSubitems %}
        {% set description = t('Available fields', domain = 'rekalogika_analytics')|trans %}
        {% set icon = block('icon_fields') %}
    {% elseif type == 'rows' %}
        {% set items = query.rowsWithoutSubitems %}
        {% set description = t('Rows', domain = 'rekalogika_analytics')|trans %}
        {% set icon = block('icon_rows') %}
    {% elseif type == 'columns' %}
        {% set items = query.columnsWithoutSubitems %}
        {% set description = t('Columns', domain = 'rekalogika_analytics')|trans %}
        {% set icon = block('icon_columns') %}
    {% elseif type == 'values' %}
        {% set items = query.valuesWithoutSubitems %}
        {% set description = t('Values', domain = 'rekalogika_analytics')|trans %}
        {% set icon = block('icon_values') %}
    {% elseif type == 'filters' %}
        {% set items = query.filtersWithoutSubitems %}
        {% set description = t('Filters', domain = 'rekalogika_analytics')|trans %}
        {% set icon = block('icon_filters') %}
    {% endif %}

    <div class="card pb-1 mb-3 mb-md-0">
        <h6 class="card-header"
            style="display: grid;
                   grid-template-columns: auto 1fr;
                   align-items: center;
                   grid-gap: 0.3em">
            {{ icon|raw }}
            <span>{{ description }}</span>
        </h6>
        <ul data-type="{{ type }}"
            class="{{ type }} list-group list-group-flush"
            style="min-height: 70px">
            {% for item in items %}{{ block("item") }}{% endfor %}
        </ul>
    </div>
{% endblock %}

{% block item %}
    {% set item = query.resolve(item) %}

    {%- set color_class -%}
        {%- if item.type == 'dimension' -%}
            list-group-item-success
        {%- elseif item.type == 'measure' -%}
            list-group-item-info
        {%- elseif item.type == 'values' -%}
            list-group-item-warning
        {%- endif -%}
    {%- endset -%}

    {%- set help -%}
        {%- if item.type == 'dimension' -%}
            {{ t('{field} is a dimension, and can be placed in the Rows, Columns, or Filters', domain = 'rekalogika_analytics', parameters = {'{field}': item.label|trans})|trans }}
        {%- elseif item.type == 'measure' -%}
            {{ t('{field} is a measure, and can be placed in the Values', domain = 'rekalogika_analytics', parameters = {'{field}': item.label|trans})|trans }}
        {%- elseif item.type == 'values' -%}
            {{ t('The value dimension, must be placed in the Rows or Columns', domain = 'rekalogika_analytics')|trans }}
        {%- endif -%}
    {%- endset -%}

    <li data-type="{{ item.type }}"
        data-value="{{ item.key }}"
        title="{{ help }}"
        class="list-group-item {{ color_class }} rounded-3 ms-1 me-1 mt-1 mb-0 py-1 px-2"
        style="cursor: grab">
        <div class="row align-items-center">
            <div class="col-auto me-auto"
                 style="display: grid;
                        grid-template-columns: auto 1fr;
                        align-items: center;
                        grid-gap: 0.3em">
                <span class="text-body-tertiary">{{ block("burger") }}</span>
                <span>{{ item.label|trans }}</span>
            </div>
            {% if item.choices %}
                <div class="col-auto ">
                    <select class="form-select form-select-sm py-0">
                        {% set selected = query.getSelectedSubItem(item.key) %}
                        {% for key, choice in item.choices %}
                            <option value="{{ key }}" {{ selected == key ? 'selected' }}>{{ choice|trans }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
        </div>
    </li>
{% endblock item %}

{% block filters %}
    {% if query.filterExpressions|length > 0 %}
        <div class="card pb-0 mt-md-3">
            <div class="card-body">
                <div class="row gx-3">
                    {% for filter in query.filterExpressions %}
                        <div class="col-md-4">{{ block("filter") }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
{% endblock filters %}

{% block filter %}
    <div class="mb-3">
        <label for="{{ filter.dimension }}-{{ id }}" class="form-label">
            {{ filter.label|trans }}
        </label>
        {{ block('filter', filter.template) }}
    </div>
{% endblock filter %}

{% block icon_fields %}
    <svg xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round"
         class="icon icon-tabler icons-tabler-outline icon-tabler-cube">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M21 16.008v-8.018a1.98 1.98 0 0 0 -1 -1.717l-7 -4.008a2.016 2.016 0 0 0 -2 0l-7 4.008c-.619 .355 -1 1.01 -1 1.718v8.018c0 .709 .381 1.363 1 1.717l7 4.008a2.016 2.016 0 0 0 2 0l7 -4.008c.619 -.355 1 -1.01 1 -1.718z" />
        <path d="M12 22v-10" />
        <path d="M12 12l8.73 -5.04" />
        <path d="M3.27 6.96l8.73 5.04" />
    </svg>
{% endblock %}

{% block icon_columns %}
    <svg xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round"
         class="icon icon-tabler icons-tabler-outline icon-tabler-layout-columns">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" />
        <path d="M12 4l0 16" />
    </svg>
{% endblock %}

{% block icon_rows %}
    <svg xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round"
         class="icon icon-tabler icons-tabler-outline icon-tabler-layout-rows">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" />
        <path d="M4 12l16 0" />
    </svg>
{% endblock %}

{% block icon_values %}
    <svg xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round"
         class="icon icon-tabler icons-tabler-outline icon-tabler-ruler-2">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M17 3l4 4l-14 14l-4 -4z" />
        <path d="M16 7l-1.5 -1.5" />
        <path d="M13 10l-1.5 -1.5" />
        <path d="M10 13l-1.5 -1.5" />
        <path d="M7 16l-1.5 -1.5" />
    </svg>
{% endblock %}

{% block icon_filters %}
    <svg xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round"
         class="icon icon-tabler icons-tabler-outline icon-tabler-filter">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" />
    </svg>
{% endblock %}

{% block burger %}
    <svg xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round"
         class="icon icon-tabler icons-tabler-outline icon-tabler-menu-2">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M4 6l16 0" />
        <path d="M4 12l16 0" />
        <path d="M4 18l16 0" />
    </svg>
{% endblock %}
